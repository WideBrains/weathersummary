<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src * self blob: data: gap:; style-src * self 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * self 'unsafe-inline' blob: data: gap:; connect-src self * 'unsafe-inline' blob: data: gap:; frame-src * self blob: data: gap:;">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.3/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.3/ol.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>Weather Summary</title>
</head>

<body>
    <div style="display: grid; grid-template-columns: 1fr 1fr;">
        <div class="wrapper">
            <div id="map"></div>
            <div id="progress"></div>
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
        </div>
        <div style="padding: 2px; margin: 2px; display: block;">
            <h1>Symbols</h1>
            <img src="img/marker.png" style="display: block; margin: 5px;" onclick='changeIconName("marker")'>
            <img src="img/house.png" style="display: block; margin: 5px;" onclick='changeIconName("house")'>
            <img src="img/hotel.png" style="display: block; margin: 5px;" onclick='changeIconName("hotel")'>
            <img src="img/building.png" style="display: block; margin: 5px;" onclick='changeIconName("building")'>
        </div>
    </div>
    <script>
        let iconName = 'marker';
        function changeIconName(name) {
            iconName = name;
        }
        function Progress(el) {
            this.el = el;
            this.loading = 0;
            this.loaded = 0;
        }
        Progress.prototype.addLoading = function () {
            ++this.loading;
            this.update();
        };
        Progress.prototype.addLoaded = function () {
            ++this.loaded;
            this.update();
        };
        Progress.prototype.update = function () {
            const width = ((this.loaded / this.loading) * 100).toFixed(1) + '%';
            this.el.style.width = width;
        };
        Progress.prototype.show = function () {
            this.el.style.visibility = 'visible';
        };
        Progress.prototype.hide = function () {
            const style = this.el.style;
            setTimeout(function () {
                style.visibility = 'hidden';
                style.width = 0;
            }, 250);
        };


        async function getPoints() {
            const response = await fetch("http://127.0.0.1:5000/getpoints", { method: "GET" });
            let features = [];
            await response.json().then((data) => {
                for (point of data) {
                    const iconFeature = createIcon(point);
                    features.push(
                        iconFeature
                    );
                }
            });
            return features;
        }

        function createIcon(point) {
            const iconStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    src: `img/${point.icon}.png`,
                }),
            });
            const iconFeature = new ol.Feature({
                geometry: new ol.geom.Point([point.x, point.y]),
                name: point.username,
            });
            iconFeature.setStyle(iconStyle);
            return iconFeature;
        }
        let username = "test";
        const progress = new Progress(document.getElementById('progress'));
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');
        const overlay = new ol.Overlay({
            element: container,
            autoPan: {
                animation: {
                    duration: 250,
                },
            },
        });
        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        let map = null;
        let vectorSource = null;
        let vectorLayer = null;
        getPoints().then((features) => {
            console.log(features);
            const source = new ol.source.OSM();
            source.on('tileloadstart', function () {
                progress.addLoading();
            });
            source.on(['tileloadend', 'tileloaderror'], function () {
                progress.addLoaded();
            });
            vectorSource = new ol.source.Vector({
                features: features,
            });

            vectorLayer = new ol.layer.Vector({
                source: vectorSource,
            });
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: source,
                    }),
                    vectorLayer
                ],
                overlays: [overlay],
                view: new ol.View({
                    center: [0, 0],
                    zoom: 2,
                }),
            });

            map.on('loadstart', function () {
                progress.show();
            });
            map.on('loadend', function () {
                progress.hide();
            });

            map.on("click", function (event) {
                let cords = ol.proj.toLonLat(map.getCoordinateFromPixel(event.pixel));
                addPoint(event.coordinate[0], event.coordinate[1], iconName).then((data) => {
                    vectorSource.addFeature(createIcon(data));
                    vectorLayer.source.refresh({ force: true });
                });

            })
        });
        async function getData(lat, lng) {
            const response = await fetch("https://api.windy.com/api/point-forecast/v2", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    "lat": lat,
                    "lon": lng,
                    "model": "gfs",
                    "parameters": ["temp", "precip", "wind"],
                    "levels": ["surface"],
                    "key": "yFiocbu2PgXmJ1wTWOrDJpDAIaMhi8gX" //placeholder
                })
            });
            return response.json();
        }

        async function addPoint(x, y, icon) {
            const response = await fetch("http://127.0.0.1:5000/addpoint",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(
                        {
                            username: username,
                            x: x,
                            y: y,
                            icon: icon
                        }
                    )
                });
            return response.json();
        }
    </script>
</body>

</html>